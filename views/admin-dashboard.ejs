<%- include('partials/header', { title: 'Admin Dashboard', siteName: siteName, isDev: isDev }) %>

<!-- Admin Dashboard Section -->
<section class="admin-dashboard-section">
    <div class="container">
        <div class="dashboard-header">
            <div class="header-content">
                <h1 class="page-title">
                    <i class="fas fa-tachometer-alt"></i> Admin Dashboard
                </h1>
                <p class="page-subtitle">Manage TDL SMP applications and server settings</p>
            </div>
            <div class="header-actions">
                <form method="POST" action="/admin/logout" style="display: inline;">
                    <button type="submit" class="btn btn-secondary">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </form>
            </div>
        </div>

        <!-- Dashboard Stats -->
        <div class="dashboard-stats">
            <div class="stat-card">
                <div class="stat-icon pending">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-number"><%= appeals.filter(a => a.status === 'pending').length %></div>
                    <div class="stat-label">Pending Appeals</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon approved">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-number"><%= appeals.filter(a => a.status === 'approved').length %></div>
                    <div class="stat-label">Approved Appeals</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon total">
                    <i class="fas fa-file-alt"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-number"><%= appeals.length %></div>
                    <div class="stat-label">Total Appeals</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon reports">
                    <i class="fas fa-flag"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-number"><%= reports ? reports.length : 0 %></div>
                    <div class="stat-label">Player Reports</div>
                </div>
            </div>
        </div>

        <!-- Management Tabs -->
        <div class="management-section">
            <div class="tab-navigation">
                <button class="tab-btn active" data-tab="appeals">
                    <i class="fas fa-gavel"></i> Appeals (<%= appeals.length %>)
                </button>
                <button class="tab-btn" data-tab="reports">
                    <i class="fas fa-flag"></i> Reports (<%= reports ? reports.length : 0 %>)
                </button>
            </div>

            <!-- Appeals Tab -->
            <div id="appeals-tab" class="tab-content active">
                <div class="section-header">
                    <h2>Ban Appeals Management</h2>
                    <div class="filter-buttons">
                        <button class="filter-btn active" data-filter="all" data-type="appeals">All</button>
                        <button class="filter-btn" data-filter="pending" data-type="appeals">Pending</button>
                        <button class="filter-btn" data-filter="approved" data-type="appeals">Approved</button>
                        <button class="filter-btn" data-filter="denied" data-type="appeals">Denied</button>
                    </div>
                </div>

            <div class="appeals-table-container">
                <table class="appeals-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Minecraft Username</th>
                            <th>Discord Username</th>
                            <th>Ban Type</th>
                            <th>Ban Reason</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% appeals.forEach(appeal => { %>
                            <tr class="appeal-row" data-status="<%= appeal.status %>">
                                <td class="date-cell">
                                    <%= new Date(appeal.submittedAt).toLocaleDateString() %>
                                </td>
                                <td class="username-cell">
                                    <strong><%= appeal.minecraftUsername %></strong>
                                </td>
                                <td class="discord-cell">
                                    <%= appeal.discordUsername %>
                                </td>
                                <td class="ban-type-cell">
                                    <span class="ban-type-badge <%= appeal.banType %>">
                                        <%= appeal.banType === 'permanent' ? 'Permanent' : 'Temporary' %>
                                    </span>
                                </td>
                                <td class="ban-reason-cell">
                                    <%= appeal.banReason ? appeal.banReason.substring(0, 50) + (appeal.banReason.length > 50 ? '...' : '') : 'N/A' %>
                                </td>
                                <td class="status-cell">
                                    <span class="status-badge status-<%= appeal.status %>">
                                        <% if (appeal.status === 'pending') { %>
                                            <i class="fas fa-clock"></i> Pending
                                        <% } else if (appeal.status === 'approved') { %>
                                            <i class="fas fa-check"></i> Approved
                                        <% } else if (appeal.status === 'denied') { %>
                                            <i class="fas fa-times"></i> Denied
                                        <% } %>
                                    </span>
                                </td>
                                <td class="actions-cell">
                                    <button class="btn btn-small btn-info" onclick="viewAppeal('<%= appeal._id %>')">
                                        <i class="fas fa-eye"></i> View
                                    </button>
                                    <% if (appeal.status === 'pending') { %>
                                        <button class="btn btn-small btn-success" onclick="reviewAppeal('<%= appeal._id %>', 'approved')">
                                            <i class="fas fa-check"></i> Approve
                                        </button>
                                        <button class="btn btn-small btn-danger" onclick="reviewAppeal('<%= appeal._id %>', 'denied')">
                                            <i class="fas fa-times"></i> Deny
                                        </button>
                                    <% } %>
                                </td>
                            </tr>
                        <% }); %>
                    </tbody>
                </table>
            </div>
            </div>

            <!-- Reports Tab -->
            <div id="reports-tab" class="tab-content">
                <div class="section-header">
                    <h2>Player Reports Management</h2>
                    <div class="filter-buttons">
                        <button class="filter-btn active" data-filter="all" data-type="reports">All</button>
                        <button class="filter-btn" data-filter="pending" data-type="reports">Pending</button>
                        <button class="filter-btn" data-filter="reviewed" data-type="reports">Reviewed</button>
                        <button class="filter-btn" data-filter="resolved" data-type="reports">Resolved</button>
                    </div>
                </div>

                <div class="reports-table-container">
                    <table class="reports-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Reported Player</th>
                                <th>Reporter</th>
                                <th>Reason</th>
                                <th>Video Proof</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% if (reports && reports.length > 0) { %>
                                <% reports.forEach(report => { %>
                                    <tr class="report-row" data-status="<%= report.status || 'pending' %>">
                                        <td class="date-cell">
                                            <%= new Date(report.submittedAt).toLocaleDateString() %>
                                        </td>
                                        <td class="player-cell">
                                            <strong><%= report.playerIdentifier %></strong>
                                        </td>
                                        <td class="reporter-cell">
                                            <%= report.reporterDiscord || 'Anonymous' %>
                                        </td>
                                        <td class="reason-cell">
                                            <%= report.reportReason ? report.reportReason.substring(0, 50) + (report.reportReason.length > 50 ? '...' : '') : 'N/A' %>
                                        </td>
                                        <td class="video-cell">
                                            <% if (report.videoProof) { %>
                                                <a href="/uploads/<%= report.videoProof %>" target="_blank" class="video-link">
                                                    <i class="fas fa-video"></i> View
                                                </a>
                                            <% } else { %>
                                                <span class="no-video">No video</span>
                                            <% } %>
                                        </td>
                                        <td class="status-cell">
                                            <span class="status-badge status-<%= report.status || 'pending' %>">
                                                <% if ((report.status || 'pending') === 'pending') { %>
                                                    <i class="fas fa-clock"></i> Pending
                                                <% } else if (report.status === 'reviewed') { %>
                                                    <i class="fas fa-eye"></i> Reviewed
                                                <% } else if (report.status === 'resolved') { %>
                                                    <i class="fas fa-check"></i> Resolved
                                                <% } %>
                                            </span>
                                        </td>
                                        <td class="actions-cell">
                                            <button class="btn btn-small btn-info" onclick="viewReport('<%= report._id %>')">
                                                <i class="fas fa-eye"></i> View
                                            </button>
                                            <% if ((report.status || 'pending') === 'pending') { %>
                                                <button class="btn btn-small btn-warning" onclick="reviewReport('<%= report._id %>', 'reviewed')">
                                                    <i class="fas fa-eye"></i> Review
                                                </button>
                                                <button class="btn btn-small btn-success" onclick="reviewReport('<%= report._id %>', 'resolved')">
                                                    <i class="fas fa-check"></i> Resolve
                                                </button>
                                            <% } %>
                                        </td>
                                    </tr>
                                <% }); %>
                            <% } else { %>
                                <tr>
                                    <td colspan="7" class="no-data">
                                        <i class="fas fa-inbox"></i>
                                        <p>No player reports found</p>
                                    </td>
                                </tr>
                            <% } %>
                        </tbody>
                    </table>
                </div>
        </div>
    </div>
</section>

<!-- Appeal Modal -->
<div id="appealModal" class="modal">
    <div class="modal-content" id="appealModalContent">
        <div class="modal-header">
            <h3>Appeal Details</h3>
            <span class="close">&times;</span>
        </div>
        <div class="modal-body" id="appealDetails">
            <!-- Appeal details will be loaded here -->
        </div>
    </div>
</div>

<!-- Report Modal -->
<div id="reportModal" class="modal">
    <div class="modal-content" id="reportModalContent">
        <!-- Content will be populated by JavaScript -->
        <div class="modal-footer">
            <button id="modalClose" class="btn btn-secondary">Close</button>
        </div>
    </div>
</div>

<script>
// Appeal management functions
function viewAppeal(appealId) {
    const appeal = <%- JSON.stringify(appeals) %>.find(a => a._id === appealId);
    if (!appeal) return;

    const modalDetails = document.getElementById('appealDetails');
    modalDetails.innerHTML = `
        <div class="appeal-details">
            <div class="detail-grid">
                <div class="detail-item">
                    <label>Minecraft Username:</label>
                    <span>${appeal.minecraftUsername}</span>
                </div>
                <div class="detail-item">
                    <label>Discord Username:</label>
                    <span>${appeal.discordUsername}</span>
                </div>
                <div class="detail-item">
                    <label>Ban Type:</label>
                    <span class="ban-type-badge ${appeal.banType}">${appeal.banType === 'permanent' ? 'Permanent' : 'Temporary'}</span>
                </div>
                <div class="detail-item">
                    <label>Ban Date:</label>
                    <span>${new Date(appeal.banDate).toLocaleDateString()}</span>
                </div>
                <div class="detail-item">
                    <label>Status:</label>
                    <span class="status-badge status-${appeal.status}">${appeal.status}</span>
                </div>
                <div class="detail-item full-width">
                    <label>Original Ban Reason:</label>
                    <p>${appeal.banReason}</p>
                </div>
                <div class="detail-item full-width">
                    <label>Appeal Reason:</label>
                    <p>${appeal.appealReason}</p>
                </div>
                <div class="detail-item full-width">
                    <label>What Happened:</label>
                    <p>${appeal.whatHappened}</p>
                </div>
                <div class="detail-item full-width">
                    <label>Why Should You Be Unbanned:</label>
                    <p>${appeal.whyUnban}</p>
                </div>
                ${appeal.additionalInfo ? `
                    <div class="detail-item full-width">
                        <label>Additional Information:</label>
                        <p>${appeal.additionalInfo}</p>
                    </div>
                ` : ''}
                <div class="detail-item">
                    <label>Submitted:</label>
                    <span>${new Date(appeal.submittedAt).toLocaleString()}</span>
                </div>
                ${appeal.reviewedAt ? `
                    <div class="detail-item">
                        <label>Reviewed:</label>
                        <span>${new Date(appeal.reviewedAt).toLocaleString()}</span>
                    </div>
                    <div class="detail-item">
                        <label>Reviewed By:</label>
                        <span>${appeal.reviewedBy}</span>
                    </div>
                ` : ''}
            </div>
        </div>
    `;

    document.getElementById('appealModal').style.display = 'block';
}

async function reviewAppeal(appealId, status) {
    if (!confirm(`Are you sure you want to ${status} this appeal?`)) return;

    try {
        const response = await fetch(`/admin/review/${appealId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ status })
        });

        const result = await response.json();
        
        if (result.success) {
            location.reload();
        } else {
            alert('Error updating appeal: ' + result.error);
        }
    } catch (error) {
        alert('Error updating appeal: ' + error.message);
    }
}

function viewReport(reportId) {
    const reports = <%-JSON.stringify(reports || [])%>;
    const report = reports.find(r => r._id == reportId);
    
    if (!report) {
        alert('Report not found');
        return;
    }

    document.getElementById('reportModalContent').innerHTML = `
        <div class="modal-header">
            <h3>Player Report Details</h3>
            <span class="close" onclick="closeReportModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div class="report-details">
                <div class="detail-item">
                    <label>Reported Player:</label>
                    <span><strong>${report.playerIdentifier}</strong></span>
                </div>
                <div class="detail-item">
                    <label>Reporter:</label>
                    <span>${report.reporterDiscord || 'Anonymous'}</span>
                </div>
                <div class="detail-item">
                    <label>Status:</label>
                    <span class="status-badge status-${report.status || 'pending'}">${report.status || 'pending'}</span>
                </div>
                <div class="detail-item full-width">
                    <label>Report Reason:</label>
                    <p>${report.reportReason}</p>
                </div>
                ${report.additionalInfo ? `
                    <div class="detail-item full-width">
                        <label>Additional Information:</label>
                        <p>${report.additionalInfo}</p>
                    </div>
                ` : ''}
                ${report.videoProof ? `
                    <div class="detail-item full-width">
                        <label>Video Proof:</label>
                        <a href="/uploads/${report.videoProof}" target="_blank" class="video-link">
                            <i class="fas fa-video"></i> View Video Evidence
                        </a>
                    </div>
                ` : ''}
                <div class="detail-item">
                    <label>Submitted:</label>
                    <span>${new Date(report.submittedAt).toLocaleString()}</span>
                </div>
                ${report.reviewedAt ? `
                    <div class="detail-item">
                        <label>Reviewed:</label>
                        <span>${new Date(report.reviewedAt).toLocaleString()}</span>
                    </div>
                    <div class="detail-item">
                        <label>Reviewed By:</label>
                        <span>${report.reviewedBy}</span>
                    </div>
                ` : ''}
            </div>
        </div>
    `;

    document.getElementById('reportModal').style.display = 'block';
}

async function reviewReport(reportId, status) {
    if (!confirm(`Are you sure you want to mark this report as ${status}?`)) return;

    try {
        const response = await fetch(`/admin/review-report/${reportId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ status })
        });

        const result = await response.json();
        
        if (result.success) {
            location.reload();
        } else {
            alert('Error updating report: ' + result.error);
        }
    } catch (error) {
        alert('Error updating report: ' + error.message);
    }
}

function closeReportModal() {
    document.getElementById('reportModal').style.display = 'none';
}

// Tab functionality
document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        const tabName = btn.dataset.tab;
        
        // Update active tab button
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        // Show/hide tab content
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });
        document.getElementById(tabName + '-tab').classList.add('active');
    });
});

// Filter functionality
document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        const filter = btn.dataset.filter;
        const type = btn.dataset.type;
        
        // Update active button within the same type
        document.querySelectorAll(`.filter-btn[data-type="${type}"]`).forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        // Filter rows based on type
        if (type === 'appeals') {
            document.querySelectorAll('.appeal-row').forEach(row => {
                if (filter === 'all' || row.dataset.status === filter) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        } else if (type === 'reports') {
            document.querySelectorAll('.report-row').forEach(row => {
                if (filter === 'all' || row.dataset.status === filter) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
    });
});
</script>

<%- include('partials/footer') %>
